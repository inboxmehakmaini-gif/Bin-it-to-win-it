<script>
    /* --- CONFIGURATION --- */
    const SUPABASE_URL = "https://fhoeywrpwhsehlwevdqc.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8Wq6Nfj5l9nH7aq3vMKrhQ_Zc-S-ndt"; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let score = 0, lives = 5, isRunning = false;
    const trash = [
        {e:'üçé', t:'org'}, {e:'üçå', t:'org'}, {e:'üçï', t:'org'}, {e:'ü•¶', t:'org'}, {e:'ü•Ø', t:'org'},
        {e:'üîã', t:'haz'}, {e:'üß™', t:'haz'}, {e:'üíâ', t:'haz'}, {e:'‚ò¢Ô∏è', t:'haz'}, {e:'üí£', t:'haz'},
        {e:'üì∞', t:'rec'}, {e:'ü•´', t:'rec'}, {e:'üçæ', t:'rec'}, {e:'üì¶', t:'rec'}, {e:'ü•õ', t:'rec'},
        {e:'üö¨', t:'non'}, {e:'ü•§', t:'non'}, {e:'ü•°', t:'non'}, {e:'üéà', t:'non'}, {e:'üëû', t:'non'}
    ];

    function play() {
        document.getElementById('start-screen').classList.add('hidden');
        isRunning = true;
        spawn();
    }

    function showFeedback(text, isCorrect) {
        const fb = document.getElementById('feedback-text');
        fb.innerText = text;
        fb.className = isCorrect ? 'correct' : 'incorrect';
        fb.style.opacity = '1';
        setTimeout(() => { fb.style.opacity = '0'; }, 800);
    }

    function spawn() {
        if(!isRunning) return;
        const info = trash[Math.floor(Math.random() * trash.length)];
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = info.e;
        el.style.left = (Math.random() * (window.innerWidth - 80)) + "px";
        el.style.top = "-80px";
        document.getElementById('game-box').appendChild(el);

        let y = -80;
        let isDragging = false;

        const fall = setInterval(() => {
            if(!isRunning) { clearInterval(fall); el.remove(); return; }
            if(!isDragging) {
                y += 2 + (score / 600);
                el.style.top = y + "px";
                if(y > window.innerHeight - 130) {
                    clearInterval(fall); el.remove();
                    showFeedback("Missed! ‚ùå", false);
                    lose();
                }
            }
        }, 20);

        el.onpointerdown = (e) => { isDragging = true; el.setPointerCapture(e.pointerId); };
        el.onpointermove = (e) => {
            if(isDragging) {
                el.style.left = (e.clientX - 35) + "px";
                el.style.top = (e.clientY - 35) + "px";
            }
        };
        el.onpointerup = (e) => {
            isDragging = false;
            const r = el.getBoundingClientRect();
            const center = { x: r.left + r.width/2, y: r.top + r.height/2 };
            let targetBin = document.getElementById(info.t).getBoundingClientRect();
            if (center.x > targetBin.left && center.x < targetBin.right && center.y > targetBin.top - 20) {
                score += 10;
                document.getElementById('score-val').innerText = score;
                showFeedback("Great! ‚úÖ", true);
                clearInterval(fall); el.remove();
            } else { y = parseFloat(el.style.top); }
        };
        setTimeout(spawn, Math.max(1000, 2800 - (score * 2.5)));
    }

    function lose() {
        lives--;
        const hearts = "‚ù§Ô∏è".repeat(Math.max(0, lives)) + "üñ§".repeat(Math.max(0, 5 - lives));
        document.getElementById('lives-val').innerText = hearts;
        if(lives <= 0) {
            isRunning = false;
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = "Score: " + score;
            save();
        }
    }

    async function save() {
        const name = document.getElementById('user-name').value || "Player";
        const content = document.getElementById('lb-content');
        try {
            await _supabase.from('leaderboard').insert([{ name: name, score: score }]);
            const { data, error } = await _supabase
                .from('leaderboard')
                .select('name, score')
                .order('score', { ascending: false })
                .limit(5);

            if (error) throw error;

            let html = "";
            data.forEach((r, i) => {
                html += `<div class="lb-row">
                            <span><span class="lb-rank">#${i+1}</span><span class="lb-name">${r.name}</span></span>
                            <span class="lb-score">${r.score}</span>
                         </div>`;
            });
            content.innerHTML = html;
        } catch(e) {
            content.innerHTML = `<div style="padding:15px; color:#666;">Leaderboard unavailable.</div>`;
        }
    }
</script>
</body>
</html>
